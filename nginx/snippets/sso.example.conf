############################
# ADVANCED (server scope)  #
############################
# Edit these three once:
set $AUTH_UPSTREAM  172.18.0.1;           # authenticator nginx host/IP
set $AUTH_PORT      8888;                 # authenticator port
set $AUTH_VHOST     authenticator.test;   # authenticator vhost/server_name

# 401 from /auth subrequest -> send user to login
error_page 401 = @error401;
location @error401 {
    return 302 http://$AUTH_VHOST/authenticate?scheme=$scheme&host=$host&return=$request_uri;
}

#########################################################
# CUSTOM LOCATION: /auth  (paste this block as-is there)#
#########################################################
location = /auth {
    internal;

    # Call authenticator's /auth-check
    proxy_pass http://$AUTH_UPSTREAM:$AUTH_PORT/auth-check;
    proxy_set_header Host $AUTH_VHOST;

    # Present app-domain cookie as Bearer so Sanctum can read it
    proxy_set_header Authorization "Bearer $cookie_auth_ticket";

    # Shared secret so ONLY this proxy can call /auth-check
    proxy_set_header X-Edge-Secret "CHANGE_ME_LONG_RANDOM";

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";

    proxy_set_header X-Original-URI    $request_uri;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent        $http_user_agent;

    proxy_next_upstream off;
    proxy_connect_timeout 2s;
    proxy_send_timeout    2s;
    proxy_read_timeout    2s;
}

#######################################################
# CUSTOM LOCATION: /   (paste this block as-is there) #
#######################################################
location / {
    # One-time ticket capture: set cookie on THIS domain, strip query
    if ($arg_ticket) {
        add_header Set-Cookie "auth_ticket=$arg_ticket; Path=/; HttpOnly; SameSite=Lax" always;
        return 302 $scheme://$host$uri;
    }

    # Gate every request via subrequest
    auth_request /auth;

    # Clean error handling to login
    proxy_intercept_errors on;
    error_page 401 = @error401;

    # Never forward client Authorization to your upstream app
    proxy_set_header Authorization "";

    # Usual proxy bits / NPM include
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    include conf.d/include/proxy.conf;
}
