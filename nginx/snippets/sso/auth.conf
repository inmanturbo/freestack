#########################################################
# CUSTOM LOCATION: /auth  (paste this block as-is there)#
#########################################################
location = /auth {
    internal;

    # Call authenticator's /auth-check
    proxy_pass $AUTH_URL;
    proxy_set_header Host $AUTH_HOST;

    # Present app-domain cookie as Bearer so Sanctum can read it
    proxy_set_header Authorization "Bearer $cookie_auth_ticket";

    # Shared secret so ONLY this proxy can call /auth-check
    proxy_set_header X-Edge-Secret $AUTH_EDGE_SECRET;

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";

    proxy_set_header X-Original-URI    $request_uri;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent        $http_user_agent;

    proxy_next_upstream off;
    proxy_connect_timeout 2s;
    proxy_send_timeout    2s;
    proxy_read_timeout    2s;
}