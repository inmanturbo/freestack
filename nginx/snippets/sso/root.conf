#######################################################
# CUSTOM LOCATION: /   (paste this block as-is there) #
#######################################################
location / {
    # One-time ticket capture: set cookie on THIS domain, strip query
    if ($arg_ticket) {
        add_header Set-Cookie "auth_ticket=$arg_ticket; Path=/; HttpOnly; SameSite=Lax" always;
        return 302 $scheme://$host$uri;
    }

    # Gate every request via subrequest
    auth_request /auth;

    # Clean error handling to login
    proxy_intercept_errors on;
    error_page 401 = @error401;

    # Never forward client Authorization to your upstream app
    proxy_set_header Authorization "";

    # Usual proxy bits / NPM include
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    include conf.d/include/proxy.conf;
}