#######################################################
# CUSTOM LOCATION: /   (paste this block as-is there) #
#######################################################
# Map whether client used HTTPS (NPM terminates TLS)
map $http_x_forwarded_proto $edge_cookie_secure {
    default "";
    https  " Secure";
}

# Optionally also handle Cloudflare's proto header:
map $http_cf_visitor $edge_cf_https {
    default "";
    "~""scheme"":""https""" " Secure";
}

location / {
    # One-time ticket capture: set cookie on THIS domain, strip query
    if ($arg_ticket) {
        add_header Set-Cookie "auth_ticket=$arg_ticket; Path=/; HttpOnly; SameSite=Lax$edge_cookie_secure$edge_cf_https" always;
        return 302 $scheme://$host$uri;
    }

    # Gate every request via subrequest
    auth_request /auth;

    # Clean error handling to login
    proxy_intercept_errors on;
    error_page 401 = @error401;

    # Never forward client Authorization to your upstream app
    proxy_set_header Authorization "";
    auth_request_set $auth_user_id $upstream_http_x_auth_user_id;

    # Usual proxy bits / NPM include
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    include conf.d/include/proxy.conf;
}